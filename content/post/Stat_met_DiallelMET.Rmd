---
title: 'lmDiallel: a new R package to fit diallel models. Multienvironment diallel
  experiments'
author: "Andrea Onofri, Niccolò Terzaroli and Luigi Russi"
date: '2021-03-05'
slug: Multi_environment_studies
categories:
- R
- Multi_environment_studies
tags:
- R
- Multi_environment_studies
- lmDiallel
- diallel_models
archives: 2021
---


```{r setup, cache = F, echo = F}
#Put at the beginning
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
knitr::knit_hooks$set(document = function(x){ 
  gsub("```\n*```r*\n*", "", x) 
})
```

In recent times, a few colleagues at my Department and I have devoted some research effort to data management for diallel mating experiments, which we have summarised in a paper ([Onofri et al., 2020](https://link.springer.com/article/10.1007/s00122-020-03716-8)) and a series of five blog posts ([see here](https://www.statforbiology.com/tags/diallel_models/)). A final topic that remains to be covered relates to the frequent possibility that these diallel experiments are repeated across years and/or locations. How should the resulting dataset be analysed?

We will start from a multi-environment full diallel experiment with 5 parental lines, in four blocks and 10 environments. The dataset is factitious and it was generated by Monte Carlo simulation, starting from the results reported in Zhang, et al. (2005; [see here](https://acsess.onlinelibrary.wiley.com/doi/abs/10.2134/agronj2004.0260)). The following box shows how we can load the data, after installing (if necessary) and loading the 'lmDiallel' package. In the same box, we use 'dplyr' to transform the explanatory variables into factors.

```{r message=FALSE, warning=FALSE}
# library(devtools) # Install if necessary
# install_github("OnofriAndreaPG/lmDiallel")
library(lmDiallel)
library(dplyr)

dataset <- read.csv("https://www.casaonofri.it/_datasets/diallelMET.csv", header = T)
dataset <- dataset %>% 
  dplyr::mutate(across(c(Env, Block, Par1, Par2), .fns = factor))
head(dataset)
```


# Fixed model fitting

For this full diallel experiment (withe selfs and reciprocals) we can fit the Griffing's model 1, including the General combining Abilities (GCA), total Specific Combining Abilities (tSCA) and reciprocal effects (REC). We also include the environment effect, the block within environment effect and all interactions between genetical effects and the environment. If we regard all effects as fixed, we can code the final model either by using the `lm() ` function, or by using the `lm.diallel()` wrapper in the 'lmDiallel' package, as shown in the box below. The two parameterisations are slightly different, although variance partitioning is totally equivalent.


```{r}
dMod <- lm(Yield ~ Env/Block + GCA(Par1, Par2) + tSCA(Par1, Par2) + 
            REC(Par1, Par2) + GCA(Par1, Par2):Env + 
             tSCA(Par1, Par2):Env + REC(Par1, Par2):Env,
           data = dataset)
# anova(dMod)

dMod2 <- lm.diallel(Yield ~ Par1 + Par2,
                    data = dataset, fct = "GRIFFING1",
                    Env = Env, Block = Block)
anova(dMod2)
```

Considering the 'diallel' object 'dMod2, the full list of genetical parameters (in each environment) is retrieved by using the `glht()` function in the 'multcomp' package. In the box below we show an excerpt of the output.

```{r}
library(multcomp)
gh <- glht(linfct = diallel.eff(dMod2))
# summary(gh, test = adjusted(type = "none"))
#                Estimate Std. Error t value Pr(>|t|)    
# g_1:1 == 0     -3.67200    0.38929  -9.432 7.06e-10 ***
# g_2:1 == 0     -0.63850    0.38929  -1.640 0.113019    
# g_3:1 == 0      1.28950    0.38929   3.312 0.002723 ** 
# g_4:1 == 0      0.03025    0.38929   0.078 0.938658    
# g_5:1 == 0      2.99075    0.38929   7.682 3.75e-08 ***
# ts_1:1:1 == 0   1.73500    1.10109   1.576 0.127184    
# ts_1:2:1 == 0   0.29150    0.80255   0.363 0.719379    
# ts_1:3:1 == 0  -1.43150    0.80255  -1.784 0.086153 .  
# ts_1:4:1 == 0  -2.10225    0.80255  -2.619 0.014504 *  
# ts_1:5:1 == 0   1.50725    0.80255   1.878 0.071631 .  
# ts_2:1:1 == 0   0.29150    0.80255   0.363 0.719379    
# ts_2:2:1 == 0   1.03050    1.10109   0.936 0.357942   
```


The ANOVA table above shows that genetical effects did not significantly interact with the environment and, therefore, we might be interested in getting estimates of average genetical effects, which can be done by using the `glht()` function and passing the `type = "means"` argument in the `diallel.eff()` call. An excerpt of the result is given in the box below.

```{r}
gh <- glht(linfct = diallel.eff(dMod2, type = "means"))
# summary(gh, test = adjusted(type = "none"))
# 	 Simultaneous Tests for General Linear Hypotheses
# 
# Linear Hypotheses:
#               Estimate Std. Error t value Pr(>|t|)    
# g_1:1 == 0    -3.46259    0.12311 -28.127  < 2e-16 ***
# g_2:1 == 0    -0.55351    0.12311  -4.496 0.000127 ***
# g_3:1 == 0     0.64251    0.12311   5.219 1.89e-05 ***
# g_4:1 == 0     0.40521    0.12311   3.292 0.002868 ** 
# g_5:1 == 0     2.96838    0.12311  24.112  < 2e-16 ***
# ts_1:1:1 == 0  1.53104    0.34820   4.397 0.000165 ***
# ts_1:2:1 == 0  0.21247    0.25379   0.837 0.410125    
# ts_1:3:1 == 0 -1.39756    0.25379  -5.507 8.87e-06 ***
# ....
# ....
# r_1:2:1 == 0  -0.20075    0.30776  -0.652 0.519943    
# r_1:3:1 == 0   2.06700    0.30776   6.716 3.98e-07 ***
# r_1:4:1 == 0  -1.33550    0.30776  -4.339 0.000192 ***
# r_1:5:1 == 0  -3.97250    0.30776 -12.908 8.19e-13 ***
# ....
# ...
  
```


# Mixed model fitting

In most cases we might be willing to regard the environment effect as random, so that all the interactions between genetical effects and the environment are random as well. A mixed model can be fitted by using the `mmer.diallel()` wrapper, that is is available in the 'lmDiallel' package. The call is very similar to a `lm.diallel()` call, as shown in the box above; we can use the 'type = "environment"' argument to specify that we want to include random environment effects. The fit can take quite a few seconds (or minutes, depending on your device...). Fixed effects and variance components can be easily retrieved from the model object, as shown in the box below.

```{r}
dMod3 <- mmer.diallel(Yield ~ Par1 + Par2,
                    data = dataset, fct = "GRIFFING1",
                    Env = Env, Block = Block, type = "environment")
dMod3$beta #fixed effects
dMod3$varcomp #variance components
```

# Random model fitting

In other instances, our aim is to estimate variance components for all genetical effects and, therefore, we might like to regard all effects as random. This is easily done by changing the call to `mmer.diallel()` and replacing `type = "environment"` with `type = "all"`.

```{r}
dMod4 <- mmer.diallel(Yield ~ Par1 + Par2,
                    data = dataset, fct = "GRIFFING1",
                    Env = Env, Block = Block, type = "all")
dMod4$beta #fixed effects
dMod4$varcomp #variance components
```


Obviously, a similar procedure can be used to fit all other diallel models to multi-environment diallel experiments.


Thanks for reading!


Andrea Onofri    
Luigi Russi    
Niccolò Terzaroli    
Department of Agricultural, Food and Environmental Sciences        
University of Perugia (Italy)        
[andrea.onofri@unipg.it](mailto:andrea.onofri@unipg.it)    

 
---

# References

* Covarrubias-Pazaran, G., 2016. Genome-Assisted Prediction of Quantitative Traits Using the R Package sommer. PLOS ONE 11, e0156744. https://doi.org/10.1371/journal.pone.0156744
* Griffing, B., 1956. Concept of general and specific combining ability in relation to diallel crossing systems. Australian Journal of Biological Science 9, 463--493.
* Hayman, B.I., 1954. The Analysis of Variance of Diallel Tables. Biometrics 10, 235. https://doi.org/10.2307/3001877
* Zhang, Y., Kang, M.S., Lamkey, K.R., 2005. DIALLEL-SAS05: A Comprehensive Program for Griffing’s and Gardner-Eberhart Analyses. Agronomy Journal 97, 1097–1106. https://doi.org/10.2134/agronj2004.0260

